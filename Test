# Tạo list kubelet-arg đã bọc "..." và giữ nguyên dấu "
- name: Build final kubelet-arg list (quoted, deduped)
  ansible.builtin.set_fact:
    kubelet_args_final: >-
      {{
        (
          (cfg['kubelet-arg'] | default([])) + kubelet_args_to_add
        )
        | unique
        | map('regex_replace','"', '\\"')           # escape " bên trong nếu có
        | map('regex_replace','^(.*)$','"\\1"')     # bọc bằng dấu "
        | map('unsafe')                              # GIỮ nguyên " ... "
        | list
      }}

- name: Merge & write config.yaml (no backup)
  ansible.builtin.copy:
    dest: "{{ rke2_config_path }}"
    content: "{{ (cfg | combine({'kubelet-arg': kubelet_args_final}, recursive=True)) | to_nice_yaml(indent=2) }}"
    owner: root
    group: root
    mode: "0644"
