# 1) SA
kubectl -n kube-system get sa flannel

# 2) DaemonSet dùng đúng SA?
kubectl -n kube-system get ds kube-flannel-ds -o jsonpath='{.spec.template.spec.serviceAccountName}{"\n"}'

# 3) ClusterRole có quyền nodes?
kubectl get clusterrole flannel -o yaml | egrep -A3 'resources:|verbs:' | sed -n '1,120p'
# cần thấy resources: nodes, pods, nodes/status ... và verbs: get,list,watch

# 4) ClusterRoleBinding bind đúng subject?
kubectl get clusterrolebinding flannel -o yaml
# cần thấy:
# roleRef.name: flannel
# subjects:
# - kind: ServiceAccount
#   name: flannel
#   namespace: kube-system
kubectl -n kube-system exec -it <pod-flannel> -c kube-flannel -- sh -c '
  H=$KUBERNETES_SERVICE_HOST; P=${KUBERNETES_PORT_443_TCP_PORT:-443};
  T=/var/run/secrets/kubernetes.io/serviceaccount/token;
  C=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt;
  wget -qO- --timeout=5 --header "Authorization: Bearer $(cat $T)" --ca-certificate $C https://$H:$P/version || echo FAIL
'
kubectl -n kube-system exec -it <pod-flannel> -c kube-flannel -- ls -l /var/run/secrets/kubernetes.io/serviceaccount
# và:
kubectl -n kube-system get ds kube-flannel-ds -o jsonpath='{.spec.template.spec.automountServiceAccountToken}{"\n"}'
kubectl -n kube-system patch ds <tên-flannel> -p \
'{"spec":{"template":{"spec":{"automountServiceAccountToken": true}}}}'
kubectl -n kube-system rollout restart ds <tên-flannel>

sudo crictl inspect <container-id> | jq -r '.info.runtimeSpec.annotations | {pod:."io.kubernetes.pod.name", ns:."io.kubernetes.pod.namespace"}'
