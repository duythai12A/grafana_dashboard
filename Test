#!/usr/bin/env bash
set -euo pipefail

# ======= CONFIG =======
HARBOR_URL="https://registry.example.com"   # Dùng FQDN + https, KHÔNG có / ở cuối
PROJECT="vlp"                               # Tên project (lowercase)
USER="admin"                                # Khuyên dùng robot account có pull
PASS="changeme"
PAGE_SIZE=100
INSECURE="-k"                               # Bỏ -k nếu cert hợp lệ
# ======================

CURL_BASE=(curl -sS -fL $INSECURE -u "$USER:$PASS")

urlencode() { jq -rn --arg x "$1" '$x|@uri'; }

echo "repository,latest_tag,pushed_at,digest"

page=1
while :; do
  # Lấy danh sách repositories trong 1 project (có phân trang)
  repos_json="$("${CURL_BASE[@]}" \
    "$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories?page=$page&page_size=$PAGE_SIZE")" || {
      echo "ERROR: list repositories failed on page $page" >&2; exit 1; }

  # Hết dữ liệu thì dừng
  [ "$(jq 'length' <<<"$repos_json")" -eq 0 ] && break

  # Lặp từng repo (tên đầy đủ: project/path/name)
  echo "$repos_json" | jq -r '.[].name' | while read -r repo_full; do
    # URL-encode toàn bộ tên repo để giữ nguyên dấu '/'
    repo_enc="$(urlencode "$repo_full")"

    # Lấy artifacts mới nhất (with_tag=true để chỉ trả artifact có tag)
    # sort=-push_time để artifact push gần nhất đứng đầu
    arts_json="$("${CURL_BASE[@]}" \
      "$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories/$repo_enc/artifacts?with_tag=true&sort=-push_time&page=1&page_size=200" \
      2>/dev/null || true)"

    if [ -z "$arts_json" ] || [ "$arts_json" = "[]" ]; then
      echo "$repo_full,-,-,-"
      continue
    fi

    # Lọc artifact có tags, chọn cái có push_time mới nhất
    csv_line="$(jq -r '
      [ .[] | select(.tags != null and (.tags|length) > 0) ] as $a
      | if ($a|length)==0 then
          ""
        else
          ( $a | max_by(.push_time) | [ .tags[0].name, .push_time, .digest ] | @csv )
        end
    ' <<<"$arts_json")"

    if [ -z "$csv_line" ] || [ "$csv_line" = "null" ]; then
      echo "$repo_full,-,-,-"
    else
      # csv_line dạng "tag","time","digest" -> bỏ dấu "
      echo "$repo_full,$(sed 's/\"//g' <<<"$csv_line")"
    fi
  done

  page=$((page+1))
done
