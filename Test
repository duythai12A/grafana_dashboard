#!/usr/bin/env bash
set -euo pipefail

# ======= CONFIG =======
HARBOR_URL="https://harbor.example.com"   # Không có dấu / ở cuối
PROJECT="myproject"
USER="admin"                               # Nên dùng robot account
PASS="******"
INSECURE="-k"                              # Bỏ nếu có TLS hợp lệ
PAGE_SIZE=100
# ======================

urlencode() { jq -rn --arg x "$1" '$x|@uri'; }

page=1
echo "repository,latest_tag,pushed_at,digest"

while :; do
  repos_json=$(
    curl $INSECURE -sS -u "$USER:$PASS" \
      "$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories?page=$page&page_size=$PAGE_SIZE"
  )

  # Hết dữ liệu?
  [ "$(jq 'length' <<<"$repos_json")" -eq 0 ] && break

  # Lặp từng repo
  echo "$repos_json" | jq -r '.[].name' | while read -r repo_full; do
    # repo_full ví dụ: "myproject/nginx" hoặc "myproject/libs/ubuntu"
    repo_enc=$(urlencode "$repo_full")

    # Lấy artifact mới nhất theo push_time, chỉ quan tâm artifact có tag
    arts_json=$(
      curl $INSECURE -sS -u "$USER:$PASS" \
        "$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories/$repo_enc/artifacts?with_tag=true&sort=-push_time&page=1&page_size=50"
    )

    # Tìm artifact đầu tiên có tag
    idx=$(jq 'to_entries
              | map(select(.value.tags != null and (.value.tags|length) > 0))
              | (.[0].key // -1)' <<<"$arts_json")

    if [ "$idx" -ge 0 ]; then
      latest_tag=$(jq -r ".[$idx].tags[0].name" <<<"$arts_json")
      pushed_at=$(jq -r ".[$idx].push_time" <<<"$arts_json")
      digest=$(jq -r ".[$idx].digest" <<<"$arts_json")
    else
      latest_tag="-"
      pushed_at="-"
      digest="-"
    fi

    echo "$repo_full,$latest_tag,$pushed_at,$digest"
  done

  page=$((page + 1))
done
