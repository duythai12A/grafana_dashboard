#!/usr/bin/env bash
set -euo pipefail

# ======= CONFIG =======
HARBOR_URL="https://registry.example.com"   # FQDN + https, KHÔNG có / ở cuối
PROJECT="vlp"                               # tên project (lowercase)
USER="admin"
PASS="changeme"
PAGE_SIZE=100
INSECURE="-k"                               # bỏ nếu cert hợp lệ
# ======================

CURL=(curl -sS -fL $INSECURE -u "$USER:$PASS")

urlencode() { jq -rn --arg x "$1" '$x|@uri'; }

# helper: GET url -> body + http_code (phần code ở dòng cuối)
get_with_code () {
  local url="$1"
  "${CURL[@]}" -w $'\nHTTP_CODE:%{http_code}' "$url" 2>/dev/null || true
}

echo "repository,latest_tag,pushed_at,digest"

page=1
while :; do
  # Lấy danh sách repo của project (có phân trang)
  resp="$("${CURL[@]}" "$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories?page=$page&page_size=$PAGE_SIZE" 2>/dev/null || true)"
  [ -z "$resp" ] && break
  [ "$(jq 'length' <<<"$resp")" -eq 0 ] && break

  # .name thường có dạng "vlp/path/name"
  echo "$resp" | jq -r '.[].name' | while read -r repo_full; do
    # repo_relative = bỏ "PROJECT/" nếu có
    repo_relative="${repo_full#"$PROJECT/"}"

    repo_enc_rel="$(urlencode "$repo_relative")"  # cho cách (1)
    repo_enc_full="$(urlencode "$repo_full")"     # cho cách (2)

    # ---- Cách (1): /projects/{project}/repositories/{repo_relative}/artifacts
    url1="$HARBOR_URL/api/v2.0/projects/$PROJECT/repositories/$repo_enc_rel/artifacts?with_tag=true&sort=-push_time&page=1&page_size=200"
    out1="$(get_with_code "$url1")"
    body1="${out1%$'\n'HTTP_CODE:*}"
    code1="${out1##*HTTP_CODE:}"

    chosen_body=""
    if [ "$code1" = "200" ] && [ -n "$body1" ] && [ "$body1" != "[]" ]; then
      chosen_body="$body1"
    else
      # ---- Fallback (2): /repositories/{project%2Frepo}/artifacts
      url2="$HARBOR_URL/api/v2.0/repositories/$repo_enc_full/artifacts?with_tag=true&sort=-push_time&page=1&page_size=200"
      out2="$(get_with_code "$url2")"
      body2="${out2%$'\n'HTTP_CODE:*}"
      code2="${out2##*HTTP_CODE:}"
      if [ "$code2" = "200" ] && [ -n "$body2" ] && [ "$body2" != "[]" ]; then
        chosen_body="$body2"
      fi
    fi

    if [ -z "$chosen_body" ]; then
      echo "$repo_full,-,-,-"
      continue
    fi

    # Lọc artifact có tag, lấy cái push_time mới nhất
    csv_line="$(jq -r '
      [ .[] | select(.tags != null and (.tags|length) > 0) ] as $a
      | if ($a|length)==0 then "" else
          ( $a | max_by(.push_time) | [ .tags[0].name, .push_time, .digest ] | @csv )
        end
    ' <<<"$chosen_body")"

    if [ -z "$csv_line" ] || [ "$csv_line" = "null" ]; then
      echo "$repo_full,-,-,-"
    else
      # csv_line dạng "tag","time","digest" -> bỏ dấu "
      echo "$repo_full,$(sed 's/\"//g' <<<"$csv_line")"
    fi
  done

  page=$((page+1))
done
