# 0) Đặt biến DATA_DIR cho đúng cụm của bạn
DATA_DIR="/u01/app/rke2"   # nếu bạn dùng mặc định thì là /var/lib/rancher/rke2

# 1) Dừng & vô hiệu hoá dịch vụ
sudo systemctl stop rke2-server || true
sudo systemctl disable rke2-server || true

# 2) Gỡ unit & binary
sudo rm -f /etc/systemd/system/rke2-server.service
sudo rm -f /etc/systemd/system/multi-user.target.wants/rke2-server.service
sudo rm -f /usr/local/bin/rke2* /usr/bin/rke2* /var/lib/rancher/rke2/bin/* 2>/dev/null || true

# 3) Xoá dữ liệu & cấu hình
sudo rm -rf ${DATA_DIR} /etc/rancher/rke2 /etc/rancher /var/lib/kubelet /var/lib/etcd
sudo rm -rf /var/lib/rancher/rke2  # nếu từng dùng mặc định

# 4) Xoá CNI & kubelet residue
sudo rm -rf /etc/cni /opt/cni /var/lib/cni /run/flannel 2>/dev/null || true

# 5) Xoá state của Cilium (nếu dùng Cilium)
sudo rm -rf /var/run/cilium /sys/fs/bpf/tc/globals 2>/dev/null || true

# 6) Gỡ network interface ảo (bỏ qua nếu không tồn tại)
sudo ip link del cni0 2>/dev/null || true
sudo ip link del flannel.1 2>/dev/null || true
sudo ip link del cilium_host 2>/dev/null || true
sudo ip link del cilium_net 2>/dev/null || true
sudo ip link del cilium_vxlan 2>/dev/null || true

# 7) Clear iptables/nftables (tuỳ chọn – chỉ nên làm lab)
# CẢNH BÁO: sẽ ảnh hưởng firewall máy!
# sudo iptables -F; sudo iptables -X; sudo iptables -t nat -F; sudo iptables -t nat -X; sudo iptables -t mangle -F; sudo iptables -t mangle -X
# sudo ip6tables -F; sudo ip6tables -X

# 8) Daemon reload
sudo systemctl daemon-reload
